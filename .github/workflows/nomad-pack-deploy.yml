name: Deploy to Nomad Cluster using nomad-pack
on:
  workflow_call:
    inputs:
      cluster_details:
        required: true
        type: string
        description: |
          An json string with details of Nomad clusters to deploy to.
          Available keys and descriptions found below:
          [
            {
              "cluster": Name of the cluster,
              "environment": Application environment to deploy,
              "api_url": Nomad cluster API address,
              "api_key_name": Keyname of the cluster API key set in the secrets
            }
          ]
          Example:
            [
              {
                "cluster": "cluster_1",
                "environment": "production",
                "api_url": "nomad_cluster1_api_url",
                "api_key_name": "nomad_cluster1_api_secret_key_name"
              },
              {
                "cluster": "cluster_2",
                "environment": "production",
                "api_url": "nomad_cluster2_api_url",
                "api_key_name": "nomad_cluster2_api_secret_key_name"
              }
            ]
      image_name:
        required: true
        type: string
        description: Docker image to deploy to cluster
      registry:
        required: true
        type: string
        description: Nomad pack registry to download.
      name:
        required: true
        type: string
        description: Unique identifier of this deployed instance of the specified pack
      pack_name:
        required: true
        type: string
        description: Nomad pack in registry to use.
      variables_file_name:
        required: true
        type: string
        description: Relative path to nomad_pack variable.
    secrets:
      gce_nomad_token:
        required: false
        description: "Nomad token for accessing Nomad GCE cluster"
      dw1_nomad_token:
        required: false
        description: "Nomad token for accessing Nomad DW1 cluster"
      hel_nomad_token:
        required: false
        description: "Nomad token for accessing Nomad HEL cluster"
      ssh_key:
        description: "SSH key to use"
        required: true
jobs:
  nomad:
    runs-on: [self-hosted, linux, nomad]
    strategy:
      matrix:
        cluster_detail: ${{fromJson(inputs.cluster_details)}}
    steps:
    - uses: actions/checkout@v2

    - uses: actions/setup-node@v2
      with:
        node-version: '16'

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.5.0
      with:
        ssh-private-key: |
          ${{ secrets.ssh_key }}

    - name: Add Nomad pack registry
      run: |
        nomad-pack registry add remerge-pack ${{ inputs.registry }}

    - name: Deploy to Nomad
      if: ${{ github.event_name != 'pull_request' }}
      env:
        NOMAD_TOKEN: ${{ secrets[matrix.cluster_detail.api_key_name] }}
        NOMAD_ADDR: ${{ matrix.cluster_detail.api_url }}
      run: |
        nomad-pack run ${{ inputs.pack_name }} \
        --var='task_image=${{ steps.meta.outputs.tags }}' \
        --var='datacenter=${{ matrix.cluster_detail.cluster }}' \
        --var='environment=${{ matrix.cluster_detail.environment }}' \
        --var='job_name=${{ inputs.name }}' --name=${{ inputs.name }} \
        --var-file=${{ inputs.variables_file_name }} \
        --registry=remerge-pack
