name: Notify repos that depend on me

on:
  workflow_call:
    inputs:
      dependants:
        type: string
        required: true
        description: "String containing a JSON list (because we can't pass a list as an input)"
      assign_to:
        type: string
        required: true
        description: "Github username we should assign the PRs to"
      os:
        description: "OS version to run the workflow on. If not provided, defaults to 'ubuntu-latest'"
        type: string
        default: ubuntu-latest
        required: false
    secrets:
      app_id:
        required: true
        description: "App id that we exchange for a token."
      app_key:
        description: "Private app key that we can exchange for a token."
        required: true

jobs:
  notify-all-dependants:
    strategy:
      matrix:
        dependant: ${{ fromJSON(inputs.dependants) }}
    runs-on: ${{ inputs.os }}
    steps:
    - run: echo ${{ matrix.dependant }}
      shell: bash

    - name: Use our App Key and App ID to get an App Token
      id: generate_app_token
      uses: tibdex/github-app-token@v1
      with:
        app_id: ${{ secrets.app_id }}
        private_key: ${{ secrets.app_key }}

        # Optional (defaults to all the Github App permissions).
        # Using a YAML multiline string to avoid escaping the JSON quotes.
        # permissions: >-
        #   {"members": "read"}

        # Optional (defaults to the current repository).
        # repository: "owner/repo"

    - name: Dispatch Event
      uses: peter-evans/repository-dispatch@v2
      with:
        token: ${{ steps.generate_app_token.outputs.token }}
        repository: remerge/${{ matrix.dependant }}
        event-type: possible-dependency-update
        client-payload: |
          {
            "repo_path": "github.com/${{ github.repository }}",
            "repo_name": "${{ github.repository }}",
            "assign_to": "${{ inputs.assign_to }}"
          }
